# å¿«é€Ÿè©•è«–åŠŸèƒ½è¨­è¨ˆæ–‡ä»¶

> **ç‰ˆæœ¬**ï¼šv1.1
> **æ›´æ–°æ—¥æœŸ**ï¼š2026-01-27
> **ç‹€æ…‹**ï¼šè¨­è¨ˆå·²å®Œæˆï¼Œå¯¦ä½œå¯é¸

> âš ï¸ **æ³¨æ„**ï¼šç›®å‰ç³»çµ±å·²æœ‰ã€ŒæŒ‰è®šã€åŠŸèƒ½ï¼ˆContentLikeButtonï¼‰å¯æ»¿è¶³åŸºæœ¬äº’å‹•éœ€æ±‚ã€‚
> æ­¤å¿«é€Ÿåæ‡‰åŠŸèƒ½ï¼ˆã€Œæˆ‘ä¹Ÿæ˜¯ã€ã€Œ+1ã€ã€Œèªªå¾—å¥½ã€ï¼‰ç‚ºå¯é¸çš„é«”é©—å¢å¼·ï¼Œå„ªå…ˆç´šè¼ƒä½ã€‚

---

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

åœ¨æ•…äº‹å…§å®¹ï¼ˆcore_story, one_liner, storyï¼‰ä¸‹æ–¹åŠ å…¥å¿«é€Ÿè©•è«–åŠŸèƒ½ï¼Œè®“ç”¨æˆ¶èƒ½ä¸€éµè¡¨é”å…±é³´ï¼š

| å¿«é€Ÿè©•è«– | Key | èªªæ˜ |
|---------|-----|------|
| æˆ‘ä¹Ÿæ˜¯ | `me_too` | è¡¨é”ç›¸åŒç¶“æ­·æˆ–æ„Ÿå— |
| +1 | `plus_one` | è¡¨ç¤ºèªåŒ |
| èªªå¾—å¥½ | `well_said` | è®šè³è¡¨é”æ–¹å¼ |

### UI ç¤ºæ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [æ•…äº‹å…§å®¹]                                                   â”‚
â”‚  ã€Œå¤§å­¸ç¤¾åœ˜é«”é©—ï¼Œä¸€çˆ¬å°±æ„›ä¸Šäº†...ã€                              â”‚
â”‚                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ æˆ‘ä¹Ÿæ˜¯(12) â”‚  â”‚  +1 (5)   â”‚  â”‚ èªªå¾—å¥½(8) â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚   [é«˜äº®=å·²æŒ‰]                                                 â”‚
â”‚                                                              â”‚
â”‚  â¤ï¸ 23    ğŸ’¬ 5                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŠŸèƒ½è¦å‰‡

- ä¸€éµé»æ“Šå³å¯ç™¼é€/å–æ¶ˆ
- åŒä¸€ç”¨æˆ¶å°åŒä¸€æ•…äº‹å¯åŒæ™‚æŒ‰å¤šç¨®å¿«é€Ÿè©•è«–ï¼ˆå¦‚åŒæ™‚æŒ‰ã€Œæˆ‘ä¹Ÿæ˜¯ã€å’Œã€Œèªªå¾—å¥½ã€ï¼‰
- åŒä¸€ç”¨æˆ¶å°åŒä¸€æ•…äº‹çš„åŒä¸€é¡å‹åªèƒ½æŒ‰ä¸€æ¬¡
- é¡¯ç¤ºæ¯ç¨®å¿«é€Ÿè©•è«–çš„æ•¸é‡çµ±è¨ˆ
- ç”¨æˆ¶å·²é»æ“Šçš„æŒ‰éˆ•æœ‰è¦–è¦ºåé¥‹ï¼ˆé«˜äº®ï¼‰

---

## äºŒã€è¨­è¨ˆæ±ºç­–

### ç‚ºä»€éº¼æ–°å¢ `reactions` è¡¨ï¼Ÿ

| æ–¹æ¡ˆ | å„ªé» | ç¼ºé» |
|------|------|------|
| **æ–°å¢ reactions è¡¨** âœ… | èªæ„æ¸…æ™°ã€ä¸å½±éŸ¿ç¾æœ‰ç³»çµ±ã€æ”¯æ´å¤šé¡å‹åæ‡‰ | å¤šä¸€å€‹è¡¨ |
| æ“´å±• likes è¡¨ | è¤‡ç”¨ç¾æœ‰è¡¨ | likes èªæ„æ˜¯å–®ä¸€æŒ‰è®šï¼Œä¸é©åˆå¤šé¡å‹ |
| æ“´å±• comments è¡¨ | è¤‡ç”¨ç¾æœ‰è¡¨ | å¿«é€Ÿè©•è«–æ²’æœ‰æ–‡å­—å…§å®¹ï¼Œä¸é©åˆ |

**çµè«–**ï¼šåƒè€ƒç¾æœ‰ `likes` è¡¨çš„æ¨¡å¼ï¼Œæ–°å¢å°ˆç”¨çš„ `reactions` è¡¨ã€‚

---

## ä¸‰ã€è³‡æ–™åº«è¨­è¨ˆ

### æ–°å¢è¡¨ï¼šreactions

```sql
-- Migration: 0028_create_reactions_table.sql

CREATE TABLE IF NOT EXISTS reactions (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  entity_type TEXT NOT NULL CHECK (entity_type IN ('core_story', 'one_liner', 'story')),
  entity_id TEXT NOT NULL,
  reaction_type TEXT NOT NULL CHECK (reaction_type IN ('me_too', 'plus_one', 'well_said')),
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  -- åŒä¸€ç”¨æˆ¶å°åŒä¸€å…§å®¹çš„åŒä¸€åæ‡‰é¡å‹åªèƒ½æœ‰ä¸€ç­†
  UNIQUE (user_id, entity_type, entity_id, reaction_type)
);

CREATE INDEX idx_reactions_entity ON reactions(entity_type, entity_id);
CREATE INDEX idx_reactions_user ON reactions(user_id);
```

### èˆ‡ç¾æœ‰è¡¨çš„é—œä¿‚

```
reactions è¡¨
â”œâ”€â”€ entity_type: 'core_story' | 'one_liner' | 'story'
â”œâ”€â”€ entity_id: å°æ‡‰å„æ•…äº‹è¡¨çš„ id
â””â”€â”€ reaction_type: 'me_too' | 'plus_one' | 'well_said'

é—œè¯ï¼š
â”œâ”€â”€ biography_core_stories.id â† reactions.entity_id (when entity_type='core_story')
â”œâ”€â”€ biography_one_liners.id   â† reactions.entity_id (when entity_type='one_liner')
â””â”€â”€ biography_stories.id      â† reactions.entity_id (when entity_type='story')
```

---

## å››ã€API è¨­è¨ˆ

### ç«¯é»

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/content/core-stories/:id/reactions` | å–å¾—å¿«é€Ÿè©•è«–çµ±è¨ˆ |
| POST | `/content/core-stories/:id/reactions` | æ–°å¢/å–æ¶ˆå¿«é€Ÿè©•è«– |
| GET | `/content/one-liners/:id/reactions` | å–å¾—å¿«é€Ÿè©•è«–çµ±è¨ˆ |
| POST | `/content/one-liners/:id/reactions` | æ–°å¢/å–æ¶ˆå¿«é€Ÿè©•è«– |
| GET | `/content/stories/:id/reactions` | å–å¾—å¿«é€Ÿè©•è«–çµ±è¨ˆ |
| POST | `/content/stories/:id/reactions` | æ–°å¢/å–æ¶ˆå¿«é€Ÿè©•è«– |

### Request/Response

```typescript
// POST /content/core-stories/:id/reactions
// Request
{
  "reaction_type": "me_too" | "plus_one" | "well_said"
}

// Responseï¼ˆtoggle è¡Œç‚ºï¼šæœ‰å‰‡åˆªé™¤ï¼Œç„¡å‰‡æ–°å¢ï¼‰
{
  "success": true,
  "data": {
    "reacted": true,  // true=å·²æ–°å¢, false=å·²å–æ¶ˆ
    "reaction_counts": {
      "me_too": 13,
      "plus_one": 5,
      "well_said": 8
    }
  }
}

// GET /content/core-stories/:id/reactions
// Response
{
  "success": true,
  "data": {
    "reaction_counts": {
      "me_too": 12,
      "plus_one": 5,
      "well_said": 8
    },
    "user_reactions": ["me_too", "well_said"]  // ç•¶å‰ç”¨æˆ¶å·²æŒ‰çš„é¡å‹ï¼ˆéœ€ç™»å…¥ï¼‰
  }
}
```

---

## äº”ã€å¾Œç«¯å¯¦ä½œ

### ä¿®æ”¹æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆ | ä¿®æ”¹å…§å®¹ |
|------|---------|
| `backend/migrations/0028_create_reactions_table.sql` | æ–°å¢ |
| `backend/src/repositories/content-interactions-repository.ts` | æ–°å¢ reaction ç›¸é—œæ–¹æ³• |
| `backend/src/services/biography-content-interactions-service.ts` | æ–°å¢ reaction æœå‹™æ–¹æ³• |
| `backend/src/routes/biography-content.ts` | æ–°å¢ reaction è·¯ç”± |

### Repository æ–°å¢æ–¹æ³•

```typescript
// content-interactions-repository.ts

// æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²æŒ‰ç‰¹å®šåæ‡‰
async hasReaction(contentType, contentId, userId, reactionType): Promise<boolean>

// æ–°å¢åæ‡‰
async addReaction(contentType, contentId, userId, reactionType): Promise<void>

// ç§»é™¤åæ‡‰
async removeReaction(contentType, contentId, userId, reactionType): Promise<void>

// å–å¾—åæ‡‰çµ±è¨ˆ
async getReactionCounts(contentType, contentId): Promise<{me_too: number, plus_one: number, well_said: number}>

// å–å¾—ç”¨æˆ¶å·²æŒ‰çš„åæ‡‰é¡å‹
async getUserReactions(contentType, contentId, userId): Promise<string[]>

// æ‰¹æ¬¡å–å¾—ç”¨æˆ¶åæ‡‰ï¼ˆç”¨æ–¼åˆ—è¡¨é é¢ï¼‰
async batchGetUserReactions(contentType, contentIds, userId): Promise<Map<string, string[]>>
```

### Service æ–°å¢æ–¹æ³•

```typescript
// biography-content-interactions-service.ts

// Toggle åæ‡‰ï¼ˆæœ‰å‰‡åˆªé™¤ï¼Œç„¡å‰‡æ–°å¢ï¼‰
async toggleReaction(contentType, contentId, userId, reactionType): Promise<{
  reacted: boolean,
  reaction_counts: ReactionCounts
}>

// å–å¾—åæ‡‰çµ±è¨ˆï¼ˆå«ç”¨æˆ¶ç‹€æ…‹ï¼‰
async getReactionsWithUserStatus(contentType, contentId, userId?): Promise<{
  reaction_counts: ReactionCounts,
  user_reactions: string[]
}>
```

---

## å…­ã€å‰ç«¯å¯¦ä½œ

### ä¿®æ”¹æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆ | ä¿®æ”¹å…§å®¹ |
|------|---------|
| `src/lib/api/services.ts` | æ–°å¢ reaction API æ–¹æ³• |
| `src/components/biography/display/QuickReactionBar.tsx` | æ–°å¢çµ„ä»¶ |
| `src/components/biography/display/BiographyCoreStories.tsx` | æ•´åˆ QuickReactionBar |
| `src/components/biography/display/BiographyOneLiners.tsx` | æ•´åˆ QuickReactionBar |
| `src/components/biography/display/BiographyStories.tsx` | æ•´åˆ QuickReactionBar |

### QuickReactionBar çµ„ä»¶è¨­è¨ˆ

```typescript
// QuickReactionBar.tsx

interface QuickReactionBarProps {
  /** å„é¡å‹åæ‡‰æ•¸é‡ */
  reactionCounts: {
    me_too: number
    plus_one: number
    well_said: number
  }
  /** ç•¶å‰ç”¨æˆ¶å·²æŒ‰çš„åæ‡‰é¡å‹ */
  userReactions: string[]
  /** Toggle åæ‡‰å›èª¿ */
  onToggle: (type: 'me_too' | 'plus_one' | 'well_said') => Promise<void>
  /** å¤§å° */
  size?: 'sm' | 'md'
  /** è‡ªè¨‚æ¨£å¼ */
  className?: string
}

// åƒè€ƒ ContentLikeButton.tsx å¯¦ä½œ optimistic update æ¨¡å¼
```

### API Service æ–°å¢æ–¹æ³•

```typescript
// services.ts - biographyContentService

// Core Story
getCoreStoryReactions: async (storyId: string) => { ... }
toggleCoreStoryReaction: async (storyId: string, reactionType: string) => { ... }

// One Liner
getOneLinerReactions: async (oneLinerId: string) => { ... }
toggleOneLinerReaction: async (oneLinerId: string, reactionType: string) => { ... }

// Story
getStoryReactions: async (storyId: string) => { ... }
toggleStoryReaction: async (storyId: string, reactionType: string) => { ... }
```

---

## ä¸ƒã€å¯¦ä½œé †åº

```
Phase 1: è³‡æ–™åº«
â”œâ”€â”€ å»ºç«‹ migration æª”æ¡ˆ
â””â”€â”€ åŸ·è¡Œ migration

Phase 2: å¾Œç«¯ Repository
â”œâ”€â”€ æ–°å¢ reaction CRUD æ–¹æ³•
â””â”€â”€ æ–°å¢æ‰¹æ¬¡æŸ¥è©¢æ–¹æ³•

Phase 3: å¾Œç«¯ Service
â”œâ”€â”€ æ–°å¢ toggleReaction æ–¹æ³•
â””â”€â”€ æ–°å¢ getReactionsWithUserStatus æ–¹æ³•

Phase 4: å¾Œç«¯ Routes
â”œâ”€â”€ æ–°å¢ GET /reactions ç«¯é»
â””â”€â”€ æ–°å¢ POST /reactions ç«¯é»

Phase 5: å‰ç«¯ API
â”œâ”€â”€ æ–°å¢ reaction API æ–¹æ³•
â””â”€â”€ æ–°å¢ TypeScript é¡å‹å®šç¾©

Phase 6: å‰ç«¯çµ„ä»¶
â”œâ”€â”€ å»ºç«‹ QuickReactionBar çµ„ä»¶
â”œâ”€â”€ å¯¦ä½œ optimistic update
â””â”€â”€ è™•ç†ç™»å…¥ç‹€æ…‹

Phase 7: æ•´åˆ
â”œâ”€â”€ æ•´åˆåˆ° BiographyCoreStories
â”œâ”€â”€ æ•´åˆåˆ° BiographyOneLiners
â””â”€â”€ æ•´åˆåˆ° BiographyStories
```

---

## å…«ã€é©—è­‰æ–¹å¼

### è³‡æ–™åº«é©—è­‰

```bash
cd backend
pnpm db:migrate
```

### å¾Œç«¯ API æ¸¬è©¦

```bash
# å–å¾—åæ‡‰ï¼ˆä¸éœ€ç™»å…¥ï¼‰
curl http://localhost:8787/api/v1/content/core-stories/{id}/reactions

# æ–°å¢åæ‡‰ï¼ˆéœ€ç™»å…¥ï¼‰
curl -X POST http://localhost:8787/api/v1/content/core-stories/{id}/reactions \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"reaction_type": "me_too"}'

# å†æ¬¡å‘¼å«æ‡‰è©²å–æ¶ˆåæ‡‰
curl -X POST http://localhost:8787/api/v1/content/core-stories/{id}/reactions \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"reaction_type": "me_too"}'
```

### å‰ç«¯æ•´åˆæ¸¬è©¦

1. è¨ªå•äººç‰©èªŒå±•ç¤ºé é¢ `/biography/profile/{slug}`
2. æ‰¾åˆ°æœ‰æ•…äº‹å…§å®¹çš„å€å¡Š
3. æ¸¬è©¦é»æ“Šå¿«é€Ÿè©•è«–æŒ‰éˆ•
4. ç¢ºèªæ•¸å­—å³æ™‚æ›´æ–°ï¼ˆoptimistic updateï¼‰
5. ç¢ºèªå·²æŒ‰ç‹€æ…‹æœ‰è¦–è¦ºåé¥‹ï¼ˆé«˜äº®ï¼‰
6. é‡æ–°æ•´ç†é é¢å¾Œç‹€æ…‹ä¿æŒ
7. æ¸¬è©¦æœªç™»å…¥ç‹€æ…‹æç¤ºç™»å…¥

---

## ä¹ã€ç›¸é—œæ–‡ä»¶

| æ–‡ä»¶ | èªªæ˜ |
|------|------|
| [current-status.md](./current-status.md) | MVP åŠŸèƒ½å¯¦ä½œç‹€æ…‹ |
| [development-timeline.md](./development-timeline.md) | é–‹ç™¼æ™‚ç¨‹è¡¨ |

---

## æ›´æ–°è¨˜éŒ„

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å…§å®¹ |
|------|------|----------|
| 2026-01-25 | v1.0 | åˆå§‹ç‰ˆæœ¬ |
| 2026-01-27 | v1.1 | æ›´æ–°ç‹€æ…‹ï¼šè¨­è¨ˆå·²å®Œæˆï¼Œå¯¦ä½œå¯é¸ã€‚ç›®å‰æŒ‰è®šåŠŸèƒ½å·²å¯æ»¿è¶³åŸºæœ¬äº’å‹•éœ€æ±‚ã€‚ |
