openapi: 3.0.3
info:
  title: Simplified-to-Traditional Chinese Conversion API
  description: |
    REST API for converting Simplified Chinese text to Traditional Chinese.
    Deployable on Cloudflare Workers for edge-optimized performance.
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: https://converter.example.com/api
    description: Production server (Cloudflare Workers)
  - url: http://localhost:8787/api
    description: Local development server (Wrangler dev)

tags:
  - name: conversion
    description: Text conversion operations
  - name: health
    description: Service health checks

paths:
  /convert:
    post:
      summary: Convert Simplified Chinese text to Traditional Chinese
      description: |
        Accepts Simplified Chinese text and returns Traditional Chinese conversion.
        Supports markdown preservation and provides conversion statistics.
      operationId: convertText
      tags:
        - conversion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConversionRequest'
            examples:
              simpleText:
                summary: Simple text conversion
                value:
                  content: "这是一个测试文件。"
                  preserveMarkdown: false
              markdownFile:
                summary: Markdown file with code blocks
                value:
                  content: |
                    # 这是标题

                    这是正文内容。

                    ```python
                    print("Hello, World!")
                    ```
                  filename: "example.md"
                  preserveMarkdown: true
                  contentType: "text/markdown"
      responses:
        '200':
          description: Conversion successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversionResponse'
              examples:
                simpleConversion:
                  summary: Simple text conversion result
                  value:
                    convertedContent: "這是一個測試檔案。"
                    conversionStats:
                      charactersConverted: 7
                      processingTimeMs: 5
                      preservedCodeBlocks: 0
                      inputSizeBytes: 27
                      outputSizeBytes: 30
                    errors: []
                markdownConversion:
                  summary: Markdown conversion with preserved code
                  value:
                    convertedContent: |
                      # 這是標題

                      這是正文內容。

                      ```python
                      print("Hello, World!")
                      ```
                    originalFilename: "example.md"
                    conversionStats:
                      charactersConverted: 12
                      processingTimeMs: 8
                      preservedCodeBlocks: 1
                      inputSizeBytes: 156
                      outputSizeBytes: 168
                    errors: []
        '400':
          description: Invalid request (bad encoding, invalid JSON, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidEncoding:
                  summary: Invalid text encoding
                  value:
                    error: "Invalid UTF-8 encoding"
                    code: "ENCODING_ERROR"
                    message: "The input text contains invalid UTF-8 characters. Please ensure your file is UTF-8 encoded."
        '413':
          description: Request entity too large (>1MB)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                fileTooLarge:
                  summary: File exceeds size limit
                  value:
                    error: "File too large"
                    code: "FILE_SIZE_EXCEEDED"
                    message: "The uploaded file exceeds the 1MB size limit. Current size: 1.2MB"
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
                example: 60
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rateLimited:
                  summary: Too many requests
                  value:
                    error: "Rate limit exceeded"
                    code: "RATE_LIMIT_EXCEEDED"
                    message: "Too many requests. Please wait 60 seconds before trying again."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                serverError:
                  summary: Unexpected server error
                  value:
                    error: "Internal server error"
                    code: "INTERNAL_ERROR"
                    message: "An unexpected error occurred during conversion. Please try again."

  /health:
    get:
      summary: Health check endpoint
      description: Returns the service health status
      operationId: healthCheck
      tags:
        - health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  summary: Service operational
                  value:
                    status: "healthy"
                    timestamp: "2025-10-11T12:00:00Z"
                    version: "1.0.0"

components:
  schemas:
    ConversionRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          description: The Simplified Chinese text to convert
          maxLength: 1048576  # 1MB in characters (approximate)
          example: "这是一个测试文件。"
        filename:
          type: string
          description: Original filename (for download naming)
          maxLength: 255
          pattern: '^[^/\\:*?"<>|]+$'  # No path separators or invalid chars
          example: "document.md"
        preserveMarkdown:
          type: boolean
          description: Whether to preserve markdown code blocks and links
          default: true
          example: true
        contentType:
          type: string
          description: MIME type of the content
          enum:
            - text/plain
            - text/markdown
          default: text/plain
          example: "text/markdown"

    ConversionResponse:
      type: object
      required:
        - convertedContent
        - conversionStats
      properties:
        convertedContent:
          type: string
          description: The converted Traditional Chinese text
          example: "這是一個測試檔案。"
        originalFilename:
          type: string
          description: Sanitized original filename
          example: "document.md"
        conversionStats:
          $ref: '#/components/schemas/ConversionStats'
        errors:
          type: array
          description: Non-fatal errors or warnings during conversion
          items:
            $ref: '#/components/schemas/ErrorDetail'
          default: []

    ConversionStats:
      type: object
      required:
        - charactersConverted
        - processingTimeMs
        - preservedCodeBlocks
        - inputSizeBytes
        - outputSizeBytes
      properties:
        charactersConverted:
          type: integer
          description: Number of Simplified characters converted
          minimum: 0
          example: 47
        processingTimeMs:
          type: number
          description: Server-side processing time in milliseconds
          minimum: 0
          example: 12.5
        preservedCodeBlocks:
          type: integer
          description: Number of markdown code blocks preserved
          minimum: 0
          example: 2
        inputSizeBytes:
          type: integer
          description: Input text size in bytes
          minimum: 0
          example: 1024
        outputSizeBytes:
          type: integer
          description: Output text size in bytes
          minimum: 0
          example: 1156

    ErrorDetail:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine-readable error code
          enum:
            - ENCODING_WARNING
            - PARTIAL_CONVERSION
            - MARKDOWN_PARSE_ERROR
            - FILE_SIZE_WARNING
          example: "ENCODING_WARNING"
        message:
          type: string
          description: Human-readable error message
          example: "Detected non-UTF-8 characters, attempted automatic conversion"
        context:
          type: object
          description: Additional error context
          additionalProperties: true
          example:
            detectedEncoding: "GB2312"

    ErrorResponse:
      type: object
      required:
        - error
        - code
        - message
      properties:
        error:
          type: string
          description: Short error title
          example: "File too large"
        code:
          type: string
          description: Machine-readable error code
          enum:
            - ENCODING_ERROR
            - FILE_SIZE_EXCEEDED
            - RATE_LIMIT_EXCEEDED
            - INVALID_REQUEST
            - INTERNAL_ERROR
          example: "FILE_SIZE_EXCEEDED"
        message:
          type: string
          description: Detailed error message for users
          example: "The uploaded file exceeds the 1MB size limit."
        details:
          type: object
          description: Optional additional error details
          additionalProperties: true

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          description: Service health status
          enum:
            - healthy
            - degraded
            - unhealthy
          example: "healthy"
        timestamp:
          type: string
          format: date-time
          description: Current server timestamp (ISO 8601)
          example: "2025-10-11T12:00:00Z"
        version:
          type: string
          description: API version
          example: "1.0.0"

  securitySchemes:
    # No authentication required - public API
    # Future consideration: Add API key authentication if abuse occurs

security: []  # Public API, no authentication required
